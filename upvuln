#!/usr/bin/bash

# ‚ú® System Update, Upgrade, and Cleanup Script ‚ú®

# Define Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# üõ†Ô∏è Check if the script is run as root
if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}üö´ Error: This script must be run as root. Use sudo!${NC}"
    exit 1
fi

echo -e "${PURPLE}üöÄ Starting system update, upgrade, and cleanup process...${NC}"

# -------------------------
# Region --- Updates
# -------------------------
echo -e "${PURPLE}RUNNING: sudo apt update --fix-missing${NC}"

for i in {1..100}; do  
    sudo apt clean
    sudo apt update --fix-missing
    status=$?
    if test $status -eq 0; then 
        echo -e "${GREEN}SUCCESS: sudo apt update --fix-missing${NC}\n"
        break
    else 
        echo -e "${RED}FAILED: sudo apt update --fix-missing (Attempt $i/100)${NC}\n"
        sleep 1m
    fi
done

# -------------------------
# Region --- Upgrades
# -------------------------
echo -e "${PURPLE}RUNNING: sudo apt upgrade -y${NC}"

for i in {1..100}; do  
    sudo apt full-upgrade -y
    status=$?
    if test $status -eq 0; then 
        echo -e "${GREEN}SUCCESS: sudo apt upgrade -y${NC}\n"
        break
    else 
        echo -e "${RED}FAILED: sudo apt upgrade -y (Attempt $i/100)${NC}\n"
        sleep 1m
    fi
done

# -------------------------
# Region --- Autoremove
# -------------------------
echo -e "${PURPLE}RUNNING: sudo apt autoremove -y${NC}"

for i in {1..100}; do  
    sudo apt autoremove -y
    status=$?
    if test $status -eq 0; then 
        echo -e "${GREEN}SUCCESS: sudo apt autoremove -y${NC}\n"
        break
    else 
        echo -e "${RED}FAILED: sudo apt autoremove -y (Attempt $i/100)${NC}\n"
        sleep 1m
    fi
done

# -------------------------
# Region --- Cleanup
# -------------------------
echo -e "${PURPLE}RUNNING: sudo apt autoclean${NC}"

for i in {1..100}; do  
    sudo apt autoclean
    status=$?
    if test $status -eq 0; then 
        echo -e "${GREEN}SUCCESS: sudo apt autoclean${NC}\n"
        break
    else 
        echo -e "${RED}FAILED: sudo apt autoclean (Attempt $i/100)${NC}\n"
        sleep 1m
    fi
done

# -------------------------
# Region --- Dependency Fixes
# -------------------------
echo -e "${PURPLE}RUNNING: Fixing broken dependencies and configuring pending packages${NC}"

for i in {1..100}; do  
    dpkg --configure -a && apt install -f -y
    status=$?
    if test $status -eq 0; then 
        echo -e "${GREEN}SUCCESS: Fixed broken dependencies and configured pending packages${NC}\n"
        break
    else 
        echo -e "${RED}FAILED: Fixing broken dependencies (Attempt $i/100)${NC}\n"
        sleep 1m
    fi
done

# -------------------------
# Region --- Self-Move
# -------------------------
echo -e "${PURPLE}üì¶ Moving upvuln to /usr/local/bin/...${NC}"

if mv "$0" /usr/local/bin/upvuln; then
    echo -e "${GREEN}‚úÖ upvuln moved to /usr/local/bin/ successfully.${NC}"
else
    echo -e "${RED}‚ùå Failed to move upvuln to /usr/local/bin/.${NC}"
    exit 1
fi

# -------------------------
# Region --- Exiting
# -------------------------
echo -e "${PURPLE}Exiting BasherUpdate...${NC}\n"
exit 0
